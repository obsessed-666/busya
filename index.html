<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>–ü–æ–¥–∞—Ä–æ–∫ –¥–ª—è –ë—É—Å–∏</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Marck+Script&display=swap" rel="stylesheet">
<style>
/* Optional custom face (if you add woff2) */
@font-face{
  font-family:"Mazut SP Demo";
  src:local("Mazut SP Demo Regular"),local("Mazut SP Demo"),url("MazutSPDemo-Regular.woff2") format("woff2");
  font-weight:400;
  font-style:normal;
  font-display:swap;
}

/* Reset + vars */
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --vh:1vh;
  --safe-top:env(safe-area-inset-top,0px);
  --panel-pad:clamp(16px,4vw,28px);
  --mist:.36;
  --goth-border:rgba(25,10,10,.62);
}
html,body{width:100%;height:100%;background:#04070f;color:#fff;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;-webkit-font-smoothing:antialiased;text-size-adjust:100%}
body{overflow:hidden}
img,video{display:block;max-width:100%}
button,[role="button"],.tap-target{-webkit-tap-highlight-color:transparent;touch-action:manipulation}

/* container */
#app{position:relative;width:100%;height:100%;overflow:hidden}
.layer{position:absolute;inset:0}

/* stacking */
.layer{z-index:0}
#forestBg,#forestOverlay,#romanceVideo,#romanceFallback,.bg-mist{pointer-events:none; z-index:0}
#beerLayer{z-index:10095; pointer-events:none} /* keep very top for beer */
#memesScene{z-index:40}
#intro{z-index:50; pointer-events:auto}
#storyScene{z-index:60}
#confessionScene{z-index:70}
#videoOverlay{z-index:100}

/* utility */
.hidden{display:none !important}
.fade-out{opacity:0 !important;transform:scale(.96) !important;transition:opacity .45s ease,transform .45s ease}

/* Backgrounds */
.bg-mist{position:absolute;inset:0;background:
  radial-gradient(circle at 18% 16%,rgba(120,150,200,var(--mist)),transparent 45%),
  radial-gradient(circle at 80% 76%,rgba(80,120,170,.22),transparent 45%);
  filter:blur(22px);opacity:.5;animation:mistMove 18s ease-in-out infinite;pointer-events:none}
@keyframes mistMove{0%,100%{transform:translateY(0)}50%{transform:translateY(-30px)}}

#forestBg{
  position:absolute;inset:0;
  background:#0b0f1a url('forest.jpg') center/cover no-repeat;
  background-size:cover;
  animation:forestDrift 22s ease-in-out infinite, forestPulse 10s ease-in-out infinite;
  transition:opacity 1.2s ease,filter 1.2s ease,transform 1.2s ease;
  will-change:transform,filter;
}
#forestOverlay{position:absolute;inset:0;background:linear-gradient(180deg,rgba(2,4,8,.76),rgba(2,3,6,.86));pointer-events:none}
#romanceVideo{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity 1.2s ease;filter:saturate(1.03) contrast(1.04);pointer-events:none}
#romanceFallback{position:absolute;inset:0;background:linear-gradient(135deg,#2a0e4a,#5b2c8c,#ff8dbb);opacity:0;transition:opacity 1.2s ease;pointer-events:none}
@keyframes forestDrift{0%,100%{background-position:50% 50%}50%{background-position:55% 45%}}
@keyframes forestPulse{0%{transform:scale(1);filter:blur(0) brightness(1)}50%{transform:scale(1.02);filter:blur(1.6px) brightness(.92)}100%{transform:scale(1);filter:blur(0) brightness(1)}}

/* Intro - gothic frame */
#intro{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;padding:var(--panel-pad);background:radial-gradient(circle at 50% 30%,rgba(100,140,200,.04),rgba(5,7,15,.96))}
#introCard{
  width:min(88vw,520px);
  text-align:center;
  padding:12px;
  border-radius:18px;
  background:linear-gradient(180deg,#060405,#0b0b0b 60%);
  box-shadow:0 30px 80px rgba(0,0,0,.8), inset 0 2px 0 rgba(255,255,255,.02);
  border:6px double var(--goth-border);
  cursor:pointer;
  position:relative;
  transition:transform .28s ease, box-shadow .28s ease;
  outline:0;
}
#introCard img{width:100%;border-radius:12px;display:block;animation:catPulse 3.4s ease-in-out infinite}
#introHint{margin-top:10px;font-size:14px;opacity:.9}
@keyframes catPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.01)}}

/* Story */
#storyScene{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;padding:var(--panel-pad);opacity:0;pointer-events:none;transition:opacity .6s ease}
#storyScene.active{opacity:1;pointer-events:auto}
#storyCard{
  width:min(92vw,900px);
  max-height:calc(100dvh - 2*var(--panel-pad) - var(--safe-top));
  background:linear-gradient(180deg, rgba(6,7,10,0.95), rgba(8,9,12,0.94));
  border-radius:18px;
  border:1px solid rgba(255,255,255,.03);
  box-shadow:0 30px 90px rgba(0,0,0,.82);
  overflow:hidden;position:relative;
}
#storyFog{
  position:absolute;inset:-30%;
  background:
    radial-gradient(circle at 20% 30%,rgba(160,180,220,.12),transparent 45%),
    radial-gradient(circle at 80% 70%,rgba(120,150,200,.1),transparent 50%);
  filter:blur(18px);
  animation:storyFog 22s ease-in-out infinite;
  pointer-events:none;
}
#storyClose{border:1px solid rgba(255,255,255,.08);background:transparent;color:#fff;padding:6px 12px;border-radius:999px;cursor:pointer;margin:12px 16px 0 auto;display:block}
#storyScroll{max-height:calc(100dvh - 160px);overflow:auto;padding:22px 20px;line-height:1.72;font-family:"Mazut SP Demo","Cinzel","Merriweather",serif;font-size:clamp(16px,4vw,18px);color:#e6e6ea;-webkit-overflow-scrolling:touch}

/* word-by-word show */
.story-word{display:inline-block;opacity:0;transform:translateY(6px);transition:opacity .28s ease,transform .28s ease}
.story-word.revealed{opacity:1;transform:translateY(0)}

/* Spoiler: inline bubble only */
.spoiler{position:relative;display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:999px;cursor:default;background:transparent;overflow:visible;pointer-events:none;opacity:.98}
.spoiler.ready{cursor:pointer;pointer-events:auto}
.spoiler .veil{position:absolute;inset:0;border-radius:999px;background:linear-gradient(180deg, rgba(12,12,14,0.7), rgba(8,8,10,0.56));box-shadow:0 10px 40px rgba(0,0,0,.65), inset 0 0 24px rgba(255,255,255,0.02);backdrop-filter:blur(20px) saturate(.85);-webkit-backdrop-filter:blur(20px) saturate(.85);transition:opacity .42s ease, transform .52s cubic-bezier(.2,.8,.2,1);opacity:1;transform:translateY(0);pointer-events:none;animation:veilFloat 6.2s ease-in-out infinite}
@keyframes veilFloat{0%{transform:translateY(0)}50%{transform:translateY(-1.6px)}100%{transform:translateY(0)}}
.spoiler .line{position:relative;z-index:3;font-family:"Mazut SP Demo","Merriweather",serif;font-size:clamp(16px,3.6vw,18px);font-weight:400;color:rgba(255,255,255,0.03);filter:blur(5px);transition:filter .32s ease,color .32s ease,opacity .32s ease;text-align:center;padding:4px 6px;border-radius:8px}
.spoiler.open .veil{opacity:0;transform:translateY(-26px)}
/* when opened: bold yellow inline text (no external bubble) */
.spoiler.open .line{color:#ffd166;filter:blur(0);font-weight:800;letter-spacing:.2px;text-shadow:0 8px 24px rgba(0,0,0,.6)}

/* Beer and effects (fixed, highest) */
#beerLayer{position:fixed;inset:0;pointer-events:none;z-index:10095}
#beerSprite{position:fixed;left:50%;top:-40%;width:min(34vw,160px);display:none;filter:drop-shadow(0 20px 45px rgba(0,0,0,.6));transform-origin:center;z-index:10096;transition:opacity .32s linear}
#puddle{position:fixed;left:0;top:0;display:none;width:28px;height:12px;border-radius:999px;opacity:0;background:radial-gradient(ellipse at 40% 30%, #fff2c4 0%, #ffdd8a 28%, #c76e21 78%);filter:blur(1.6px);transform:translate(-50%,0);z-index:10094}
.ripple{position:fixed;left:0;top:0;display:none;width:20px;height:8px;border-radius:50%;border:2px solid rgba(255,220,130,.8);opacity:0;transform:translate(-50%,0);z-index:10093}
.splash,.foam{position:fixed;border-radius:50%;pointer-events:none;z-index:10092}

/* stain blobs */
.stain{position:fixed;border-radius:50%;pointer-events:none;mix-blend-mode:multiply;opacity:0;filter:blur(6px);z-index:10091;transform-origin:center center;animation:stainWiggle 3.6s ease-in-out infinite}
@keyframes stainWiggle{0%{transform:scale(0.98) translateY(0)}50%{transform:scale(1.02) translateY(-2px)}100%{transform:scale(0.98) translateY(0)}}

/* Memes tuned for iPhone 14 Plus */
#memesScene{position:absolute;inset:0;opacity:0;pointer-events:none;transition:opacity .6s ease}
#memesScene.active{opacity:1;pointer-events:auto}
.meme{position:absolute;left:0;top:0;width:clamp(72px,18vw,110px);padding:6px;border-radius:12px;background:linear-gradient(180deg,rgba(255,210,225,.12),rgba(120,80,120,.06));border:1px solid rgba(255,210,230,.06);box-shadow:0 14px 40px rgba(0,0,0,.45);overflow:hidden;cursor:pointer;backdrop-filter:blur(3px)}
.meme img{width:100%;height:100%;object-fit:cover;filter:contrast(1.03) saturate(1.02)}
.meme::after{content:"";position:absolute;inset:0;box-shadow:inset 0 0 30px rgba(0,0,0,.28)}

/* Confession */
#confessionScene{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;padding:var(--panel-pad);opacity:0;pointer-events:none;transition:opacity .6s ease}
#confessionScene.active{opacity:1;pointer-events:auto}
#confessionBox{width:min(92vw,900px);max-height:calc(100dvh - 2*var(--panel-pad));background:rgba(255,255,255,.06);border-radius:18px;border:1px solid rgba(255,255,255,.08);box-shadow:0 30px 100px rgba(0,0,0,.45);padding:clamp(18px,4vw,28px);text-align:center;color:#ffe4ec;overflow:auto}
#confessionText{font-family:"Marck Script","Brush Script MT","Segoe Script","Comic Sans MS",cursive;font-size:clamp(26px,6vw,36px);line-height:1.8}
#confessionText p{opacity:0;transform:translateY(8px);transition:.5s ease;margin:10px 0}
.word{display:inline-block;opacity:0;transform:translateY(6px);transition:opacity .36s ease,transform .36s ease}
.char{display:inline-block;transform-origin:center bottom;animation:charShake 1.7s ease-in-out infinite}
@keyframes charShake{0%{transform:translate(0,0) rotate(0)}25%{transform:translate(-2px,1px) rotate(-2deg)}50%{transform:translate(2px,-1px) rotate(2deg)}75%{transform:translate(-1px,-1px) rotate(-1deg)}100%{transform:translate(0,0) rotate(0)}}

/* heart button initially disabled until confession fully displayed */
#heartBtn{font-size:52px;margin-top:12px;cursor:pointer;color:#ff4f7d;text-shadow:0 6px 18px rgba(255,79,125,.45);animation:heartPulse 1.6s ease-in-out infinite;pointer-events:none;opacity:0.92}
#heartBtn.enabled{pointer-events:auto}
@keyframes heartPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.12)}}

/* heart caption hidden until confession done */
#heartCaption{opacity:0;transform:translateY(8px);transition:opacity .42s ease, transform .42s ease; font-size:13px; color: #ffdfe8}
#heartCaption.visible{opacity:1;transform:translateY(0);}

/* video overlay */
#videoOverlay{position:absolute;inset:0;background:rgba(0,0,0,.92);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s ease;padding:var(--panel-pad)}
#videoOverlay.active{opacity:1;pointer-events:auto}
#finalVideo{width:min(92vw,900px);max-height:78vh;border-radius:12px;background:#000;box-shadow:0 20px 70px rgba(0,0,0,.6)}
#videoPlaceholder{display:none;color:#ffe4ec;text-align:center}
</style>
</head>
<body>

<div id="app">
  <div id="forestBg" class="layer" aria-hidden="true"></div>
  <div id="forestOverlay" class="layer" aria-hidden="true"></div>
  <video id="romanceVideo" class="layer" src="romance.mp4" muted playsinline webkit-playsinline loop preload="metadata" aria-hidden="true"></video>
  <div id="romanceFallback" class="layer" aria-hidden="true"></div>
  <div class="layer bg-mist" aria-hidden="true"></div>

  <section id="intro" aria-label="–í—Å—Ç—É–ø–ª–µ–Ω–∏–µ">
    <div id="introCard" class="tap-target" role="button" tabindex="0" aria-label="–ù–∞–∂–º–∏ –Ω–∞ –∫–æ—Ç–∏–∫–∞">
      <img src="cat.jpg" alt="–∫–æ—Ç –ë—É—Å—è ‚Äî –Ω–∞–∂–º–∏" onerror="this.style.display='none'" />
      <div id="introHint">–Ω–∞–∂–º–∏ –Ω–∞ –∫–æ—Ç–∏–∫–∞ üêæ</div>
    </div>
  </section>

  <section id="storyScene" aria-label="–†–∞—Å—Å–∫–∞–∑">
    <div id="storyCard">
      <div id="storyFog" aria-hidden="true"></div>
      <button id="storyClose" type="button">–Ω–∞–∑–∞–¥</button>
      <div id="storyScroll" tabindex="0" aria-label="–ò—Å—Ç–æ—Ä–∏—è">
        <p>–û–¥–Ω–∞–∂–¥—ã —è —Å–∏–¥–µ–ª –∫–∞–∫ –Ω–∏ –≤ —á—ë–º –Ω–µ –±—ã–≤–∞–ª–æ –¥–æ–º–∞, —Å–ª—É—à–∞–ª –≥—Ä—É—Å—Ç–Ω—É—é –º—É–∑—ã–∫—É, —Å–º–æ—Ç—Ä–µ–ª –≤ –æ–∫–Ω–æ, –¥—É–º–∞–ª –æ —Å–≤–æ—ë–º —Ç–ª–µ–Ω–Ω–æ–º –±—É–¥—É—â–µ–º, –∫–∞–∫ –≤–¥—Ä—É–≥‚Ä¶ –∑–≤–æ–Ω–æ–∫ –≤ –¥–≤–µ—Ä—å. –Ø –æ–ø–µ—à–∏–ª, –≤–µ–¥—å –±—ã–ª–æ 3 —á–∞—Å–∞ –Ω–æ—á–∏, –∏ —è –Ω–∏–∫–æ–≥–æ –Ω–µ –∂–¥–∞–ª. –í —Ç–æ—Ç –¥–µ–Ω—å –æ—â—É—â–µ–Ω–∏—è –ø–æ–∏—Å—Ç–∏–Ω–µ –±—ã–ª–∏ —Å—Ç—Ä–∞–Ω–Ω—ã–µ. –ù–∞ –¥–≤–æ—Ä–µ —Å—Ç–æ—è–ª–∞ –ª—ë–≥–∫–∞—è –¥—ã–º–∫–∞, –∞ –Ω–∞ –Ω–µ–±–µ –æ—Ç—á—ë—Ç–ª–∏–≤–æ –≤–∏–¥–Ω–µ–ª–∞—Å—å —è—Ä–∫–∞—è –ø–æ–ª–Ω–∞—è –ª—É–Ω–∞, –ø—Ä—è–º–æ –∫–∞–∫ —Å –∫–∞—Ä—Ç–∏–Ω–∫–∏ ‚Äî –º—Ä–∞—á–Ω–∞—è –∏ –∑–∞–≥–∞–¥–æ—á–Ω–∞—è. –ü–æ–≥–æ–¥–∞ –∑–∞ –æ–∫–Ω–æ–º –ª–∏—à—å –¥–æ–±–∞–≤–ª—è–ª–∞ —Ç–∞–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω–æ–º—É —Å–æ–±—ã—Ç–∏—é.</p>
        <p>¬´–£ —Å–æ—Å–µ–¥–∞, –Ω–∞–≤–µ—Ä–Ω–æ–µ, —á—Ç–æ-—Ç–æ —Å—Ç—Ä—è—Å–ª–æ—Å—å¬ª, ‚Äî –ø–æ—á–µ—Å–∞–≤ —Ä–µ–ø—É, –ø–æ–¥—É–º–∞–ª —è. –ù–æ —á—É–≤—Å—Ç–≤–æ —Ç—Ä–µ–≤–æ–≥–∏ –∑–∞—Ç–º–∏–ª–æ –º–æ–π —Ä–∞—Å—Å—É–¥–æ–∫, –∏ —è –º–µ–¥–ª–µ–Ω–Ω–æ, —Ç–∏—Ö–∏–º —à–∞–≥–æ–º –ø–æ–¥–æ—à—ë–ª –∫ –≤—Ö–æ–¥–Ω–æ–π –¥–≤–µ—Ä–∏. –°—Ç–æ—è–ª–∞ –ø–æ–ª–Ω–µ–π—à–∞—è —Ç–∏—à–∏–Ω–∞. –Ø –ø—ã—Ç–∞–ª—Å—è –ø—Ä–∏—Å–ª—É—à–∞—Ç—å—Å—è –∫ –∑–≤—É–∫–∞–º –ø–æ —Ç—É —Å—Ç–æ—Ä–æ–Ω—É –¥–≤–µ—Ä–∏, –Ω–æ –∏—Ö –Ω–µ –±—ã–ª–æ. –Ø —Å—Ç–æ—è–ª —Ç–∞–∫ –≥–¥–µ-—Ç–æ –º–∏–Ω—É—Ç—É, –Ω–æ –ø–æ –æ—â—É—â–µ–Ω–∏—è–º –æ–Ω–∞ –¥–ª–∏–ª–∞—Å—å —Ü–µ–ª—É—é –≤–µ—á–Ω–æ—Å—Ç—å. –í –≥–æ–ª–æ–≤–µ –±—ã–ª–∞ –ª–∏—à—å —Ä–∞—Å—Ç–µ—Ä—è–Ω–Ω–æ—Å—Ç—å –∏ —Å–º—è—Ç–µ–Ω–∏–µ.</p>
        <p>–ö–∞–∫ –≤–¥—Ä—É–≥ —è —É—Å–ª—ã—à–∞–ª —Å—Ç—Ä–∞–Ω–Ω—ã–π –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø, –±—É–¥—Ç–æ –∫—Ç–æ-—Ç–æ –º–µ–¥–ª–µ–Ω–Ω–æ, –Ω–æ —É–≤–µ—Ä–µ–Ω–Ω–æ –≤–æ–¥–∏–ª –Ω–æ–≥—Ç–µ–º –ø–æ —Å—Ç–∞–ª—å–Ω–æ–º—É –ª–∏—Å—Ç—É. –Ø —Å–∏–ª—å–Ω–æ –Ω–∞–ø—Ä—è–≥—Å—è, –≤—Å—ë —Ç–µ–ª–æ —Å –≥–æ–ª–æ–≤—ã –¥–æ –Ω–æ–≥ –ø—Ä–æ–±—Ä–∞–ª–æ –º—É—Ä–∞—à–∫–∞–º–∏, —è –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞–ª —Ä–µ–∑–∫–∏–π —Å–∫–∞—á–æ–∫ –∞–¥—Ä–µ–Ω–∞–ª–∏–Ω–∞ ‚Äî —Ä–∞–∑—É–º —è–≤–Ω–æ —á—É–≤—Å—Ç–≤–æ–≤–∞–ª, —á—Ç–æ —á—Ç–æ-—Ç–æ —Ç—É—Ç –Ω–µ —Ç–∞–∫. –Ø –Ω–∞–±—Ä–∞–ª—Å—è —Å–º–µ–ª–æ—Å—Ç–∏ –∏, —Å—Ü–µ–ø–∏–≤ –∑—É–±—ã, –≤—ã–¥–∞–≤–∏–ª –∏–∑ —Å–µ–±—è: ‚ÄûWer ist da?‚Äú –ù–æ, –∫–∞–∫ —è –∏ –æ–∂–∏–¥–∞–ª, –æ—Ç–≤–µ—Ç–∞ –Ω–µ –ø–æ—Å—Ç—É–ø–∏–ª–æ. –õ–∏—à—å —ç—Ç–æ—Ç –¥–æ –¥—Ä–æ–∂–∏ –ø—Ä–æ—Ç–∏–≤–Ω—ã–π –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–π –∑–≤—É–∫, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–Ω–∏–∫–∞–ª –≤ –∫–∞–∂–¥—É—é –∫–ª–µ—Ç–æ—á–∫—É –º–æ–∑–≥–∞‚Ä¶ –û—â—É—â–∞–ª–æ—Å—å, –±—É–¥—Ç–æ —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä—è–º–æ —É –º–µ–Ω—è –≤ –≥–æ–ª–æ–≤–µ, –±—É–¥—Ç–æ –∫—Ç–æ-—Ç–æ —Å –∏–∑–¥—ë–≤–∫–æ–π –≤–æ–¥–∏—Ç –ø–æ –Ω–µ–º—É —Å–∫—Ä–∏–ø—É—á–µ–π –∂–µ–ª–µ–∑—è–∫–æ–π.</p>
        <p>–ò –≤–¥—Ä—É–≥ ‚Äî —Ç–∏—à–∏–Ω–∞. –°–Ω–æ–≤–∞. –Ø –ø–æ–Ω–∏–º–∞–ª, —á—Ç–æ –∫—Ç–æ –±—ã —Ç–æ –Ω–∏ –±—ã–ª –∑–∞ –¥–≤–µ—Ä—å—é, –≤–µ—Ä–æ—è—Ç–Ω–æ, —Ç–æ–∂–µ —É—Å–ª—ã—à–∞–ª, –∫–∞–∫ —è —Å—Ç–æ—é –∏ –º–æ–ª—á–∞ —Å–ª—É—à–∞—é, –≤–Ω–∏–º–∞—è —ç—Ç–æ—Ç –ø—Å–∏—Ö–æ–¥–µ–ª–∏—á–µ—Å–∫–∏–π —É–∂–∞—Å. –ì–¥–µ-—Ç–æ —Å–ø—É—Å—Ç—è —Å–µ–∫—É–Ω–¥ 20 —Ä–∞–∑–¥–∞–ª—Å—è –≥—Ä–æ–º–∫–∏–π –∂–µ–ª–µ–∑–Ω—ã–π –∑–≤—É–∫ ‚Äî –∑–≤—É–∫ –ø–∞–¥–µ–Ω–∏—è –ø—Ä—è–º–æ –ø–µ—Ä–µ–¥ –º–æ–µ–π –≥—Ä—ë–±–∞–Ω–Ω–æ–π –¥–≤–µ—Ä—å—é. –Ø –Ω–∞–±—Ä–∞–ª—Å—è —Å–º–µ–ª–æ—Å—Ç–∏ –∏ –ø—Ä–∏—Å–ª–æ–Ω–∏–ª —É—Ö–æ –∫ –¥–≤–µ—Ä–∏, —á—Ç–æ–±—ã –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ –∂–µ —É–ø–∞–ª–æ... –∏ —á—Ç–æ, —á—ë—Ä—Ç –≤–æ–∑—å–º–∏, —Ç—É—Ç –≤–æ–æ–±—â–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç.</p>
        <p>–ö–∞–∫ –≤–¥—Ä—É–≥, –∫–∞–∫ –≥—Ä–æ–º —Å—Ä–µ–¥–∏ —è—Å–Ω–æ–≥–æ –¥–Ω—è, –∫–∞–∫ —Å–Ω–µ–≥ –≤ –∏—é–ª–µ, —è —É—Å–ª—ã—à–∞–ª –Ω–µ–∂–Ω—ã–π, –º–∏–ª—ã–π –∏ –¥–æ –±–æ–ª–∏ –∑–Ω–∞–∫–æ–º—ã–π –∂–µ–Ω—Å–∫–∏–π –≥–æ–ª–æ—Å, –∫–æ—Ç–æ—Ä—ã–π —Å—Ç–µ—Å–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–∏–∑–Ω—ë—Å:</p>

        <!-- SPOILER: inline bubble only -->
        <div class="spoiler" id="spoiler" role="button" aria-pressed="false" aria-disabled="true" tabindex="-1">
          <div class="veil" aria-hidden="true"></div>
          <div class="line" aria-hidden="true">‚Äî –û–π, –∏–∑–≤–∏–Ω–∏, —É –º–µ–Ω—è –ø–∏–≤–æ —É–ø–∞–ª–æ.</div>
        </div>

      </div>
    </div>
  </section>

  <div id="beerLayer" class="layer" aria-hidden="true">
    <img id="beerSprite" src="beer.png" alt="–±–∞–Ω–∫–∞ Desperados" onerror="this.style.display='none'" />
    <div id="puddle"></div>
    <div class="ripple" id="ripple"></div>
    <!-- stains will be appended here dynamically -->
  </div>

  <section id="memesScene" aria-label="–ú–µ–º—ã"></section>

  <section id="confessionScene" aria-label="–ü—Ä–∏–∑–Ω–∞–Ω–∏–µ">
    <div id="confessionBox">
      <!-- UPDATED CONFESSION TEXT (user requested) -->
      <div id="confessionText">
        –±—É—Å—è, –∫–æ—Ç–∏–∫, —è –ø–æ–∑–Ω–∞–∫–æ–º–∏–ª—Å—è —Å —Ç–æ–±–æ–π –ª–∏—à—å –º–µ—Å—è—Ü –Ω–∞–∑–∞–¥, –Ω–æ –≤–æ –º–Ω–µ —Ç–µ–ø–ª–∏—Ç—Å—è —á—É–≤—Å—Ç–≤–æ, –±—É–¥—Ç–æ —è –∑–Ω–∞–ª —Ç–µ–±—è –≤–æ –≤—Å–µ—Ö —Å–≤–æ–∏—Ö –ø—Ä–æ—à–ª—ã—Ö –∂–∏–∑–Ω—è—Ö, –≤–µ–¥—å –±–æ–ª–µ–µ –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –º–µ—Ç—á–∞ –Ω–∞ –∑–µ–º–ª–µ –µ—â–µ –Ω–µ –±—ã–ª–æ. –ò –Ω–µ –±—É–¥–µ—Ç. –¢—ã –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –¥–∞—Ä–∏—à—å –º–Ω–µ —Ç—É —Å–∞–º—É—é –∏—Å–∫—Ä–µ–Ω–Ω—é—é –¥–µ—Ç—Å–∫—É—é —Ä–∞–¥–æ—Å—Ç—å –∏ —É–ª—ã–±–∫—É, –∫–æ—Ç–æ—Ä—ã—Ö —É –º–µ–Ω—è –æ—á–µ–Ω—å –¥–∞–≤–Ω–æ –Ω–µ –±—ã–ª–æ. –ø–æ–ª–≥–æ–¥–∞ –Ω–∞–∑–∞–¥ —è –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å, —á—Ç–æ —Å–º–æ–≥—É –ø–æ–ª—é–±–∏—Ç—å –∫–æ–≥–æ-—Ç–æ —Ç–∞–∫ —Å–∏–ª—å–Ω–æ –∫–∞–∫ —Ç–µ–±—è. –ï—Å–ª–∏ –±—ã —è –±—ã–ª —Å–ª–µ–ø—ã–º - —Ç—ã –±—ã–ª–∞ –±—ã –º–æ–∏–º –∑—Ä–µ–Ω–∏–µ–º. –ï—Å–ª–∏ –±—ã —è –±—ã–ª –≥–ª—É—Ö–∏–º - —Ç—ã –±—ã–ª–∞ –±—ã –º–æ–∏–º —Å–ª—É—Ö–æ–º. –ï—Å–ª–∏ –±—ã —è –±—ã–ª –Ω–µ–º—ã–º - —Ç—ã –±—ã–ª–∞ –±—ã –º–æ–∏ –≥–æ–ª–æ—Å–æ–º. –ï—Å–ª–∏ –±—ã –Ω–µ –±—ã–ª–æ —Ç–µ–±—è - –Ω–µ –±—ã–ª–æ –±—ã –º–µ–Ω—è. –û—á–µ–Ω—å —Å–∏–ª—å–Ω–æ –∂–¥—É –Ω–∞—à–µ–π –≤—Å—Ç—Ä–µ—á–∏, —è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ—Ü–µ–ª—É—é —Ç–µ–±—è –ø–æ–¥ –ø—Ä–∏–ø–µ–≤ —ç—Ç–æ–π –ø–µ—Å–Ω–∏.
      </div>
      <div id="heartBtn" class="tap-target" role="button" tabindex="-1" aria-label="–ù–∞–∂–∞—Ç—å —Å–µ—Ä–¥–µ—á–∫–æ">üíò</div>
      <div id="heartCaption">—Å–µ—Ä–¥–µ—á–∫–æ —Ç—ã–∫</div>
    </div>
  </section>

  <div id="videoOverlay" aria-hidden="true">
    <div>
      <video id="finalVideo" src="video.mp4" controls playsinline webkit-playsinline preload="metadata"></video>
      <div id="videoPlaceholder">
        <div style="font-size:46px">üé¨</div>
        <div>–í–∏–¥–µ–æ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –∑–¥–µ—Å—å</div>
      </div>
    </div>
  </div>

  <!-- audios: use these elements (names must match files in repo) -->
  <audio id="darkMusic" src="dark.mp3" preload="auto" loop playsinline></audio>
  <audio id="loveMusic" src="love.mp3" preload="auto" loop playsinline></audio>
  <audio id="beerSfx" src="beer-sfx.mp3" preload="auto"></audio>
</div>

<!-- NOTE: upload second meme image with exact filename: memes_extra.png (50% of memes attempt to use it) -->

<script>
/* Settings */
const BEER_BASE_DURATION_MS = 1450
const MEME_COUNT = 18
const VOLUME_DARK = 0.18
const VOLUME_LOVE = 0.22
const SFX_VOLUME = 0.6
const STORY_WORD_DELAY_MS = 56
const WORD_DELAY_MS = 90
const MEME_EXTRA_FILENAME = 'memes_extra.png' // upload to repo

/* helpers */
const $ = s => document.querySelector(s)
const $$ = s => Array.from(document.querySelectorAll(s))

/* elements */
const introCard = $('#introCard')
const intro = $('#intro')
const storyScene = $('#storyScene')
const storyClose = $('#storyClose')
const storyScroll = $('#storyScroll')
const storyFog = $('#storyFog')
const spoiler = $('#spoiler')
const spoilerLine = spoiler.querySelector('.line')
let beerLayer = $('#beerLayer')
const beerSprite = $('#beerSprite')
const puddle = $('#puddle')
const ripple = $('#ripple')
const memesScene = $('#memesScene')
const confessionScene = $('#confessionScene')
const confessionText = $('#confessionText')
const heartBtn = $('#heartBtn')
const heartCaption = $('#heartCaption')
const darkMusic = $('#darkMusic')   // audio element
const loveMusic = $('#loveMusic')   // audio element
const beerSfx = $('#beerSfx')
const romanceVideo = $('#romanceVideo')
const finalVideo = $('#finalVideo')

let audioPrimed = false
let beerStarted = false
let romanceStarted = false
let romanceAudioStarted = false
let memeAnimationId = null
let puddleTimer = null
let loveWasPlayingBeforeVideo = false
let stainsCreated = []

/* viewport for mobile */
function syncVH(){
  const vh = (window.visualViewport?.height || window.innerHeight) * 0.01
  document.documentElement.style.setProperty('--vh', `${vh}px`)
}
syncVH()
window.addEventListener('resize', syncVH, {passive:true})

/* fade helper */
function fadeAudio(audio, target, duration){
  const start = audio.volume || 0
  const diff = target - start
  const t0 = performance.now()
  function step(now){
    const p = Math.min((now - t0) / duration, 1)
    audio.volume = start + diff * p
    if(p < 1) requestAnimationFrame(step)
  }
  requestAnimationFrame(step)
}

/* Strong unlock function:
   MUST be called inside a real user gesture (click/tap).
   It will "prime" the audio subsystem by playing+pausing both tracks,
   then mark audioPrimed so later play() calls won't be blocked by iOS.
*/
function unlockAudioImportant(){
  if(audioPrimed) return
  audioPrimed = true

  try {
    // tiny volume so priming is silent
    darkMusic.volume = 0.01
    loveMusic.volume = 0.01

    // play & immediately pause both to unlock them in iOS
    darkMusic.play().then(()=>{ darkMusic.pause(); darkMusic.currentTime = 0 }).catch(()=>{})
    loveMusic.play().then(()=>{ loveMusic.pause(); loveMusic.currentTime = 0 }).catch(()=>{})
  } catch(e){
    // best-effort; if play is blocked, fallback resume listeners will help later
  }
}

/* robust play with resume fallback */
function playWithFadeAndResume(audioEl, targetVolume, fadeMs){
  try{
    audioEl.volume = 0
    const p = audioEl.play()
    if(p && typeof p.then === 'function'){
      p.then(()=> fadeAudio(audioEl, targetVolume, fadeMs)).catch(()=>{
        // blocked: schedule on next user gesture
        const resume = ()=>{
          audioEl.play().then(()=> fadeAudio(audioEl, targetVolume, fadeMs)).catch(()=>{})
          window.removeEventListener('touchstart', resume)
          window.removeEventListener('click', resume)
        }
        window.addEventListener('touchstart', resume, {once:true,passive:true})
        window.addEventListener('click', resume, {once:true})
      })
    } else {
      fadeAudio(audioEl, targetVolume, fadeMs)
    }
  }catch(e){
    const resume = ()=>{
      audioEl.play().then(()=> fadeAudio(audioEl, targetVolume, fadeMs)).catch(()=>{})
      window.removeEventListener('touchstart', resume)
      window.removeEventListener('click', resume)
    }
    window.addEventListener('touchstart', resume, {once:true,passive:true})
    window.addEventListener('click', resume, {once:true})
  }
}

/* prepare story words */
function prepareStoryWords(){
  const ps = $$('#storyScroll p')
  ps.forEach(p=>{
    const raw = p.textContent.trim()
    const parts = raw.match(/\S+|\s+/g) || [raw]
    p.innerHTML = ''
    parts.forEach(part=>{
      if(/\s+/.test(part)){
        p.appendChild(document.createTextNode(part))
        return
      }
      const span = document.createElement('span')
      span.className = 'story-word'
      span.textContent = part
      p.appendChild(span)
      p.appendChild(document.createTextNode(' '))
    })
  })
}

/* reveal words one-by-one; return total duration (ms) */
function revealStoryWords(){
  const words = $$('#storyScroll .story-word')
  words.forEach((w,i)=> setTimeout(()=> w.classList.add('revealed'), i * STORY_WORD_DELAY_MS))
  return words.length * STORY_WORD_DELAY_MS
}

/* enable spoiler after story finished */
function enableSpoiler(){
  spoiler.classList.add('ready')
  spoiler.setAttribute('aria-disabled','false')
  spoiler.tabIndex = 0
}

/* show story on first click (user gesture) */
function showStory(){
  // this function is called inside click handler on introCard -> guaranteed user gesture
  unlockAudioImportant()

  // Immediately start dark music inside the same gesture so it's never blocked
  try {
    darkMusic.currentTime = 0
    darkMusic.volume = 0
    const p = darkMusic.play()
    if(p && typeof p.then === 'function'){
      p.then(()=> fadeAudio(darkMusic, VOLUME_DARK, 900)).catch(()=> {
        // fallback: schedule resume on next gesture
        const resume = ()=>{
          darkMusic.play().then(()=> fadeAudio(darkMusic, VOLUME_DARK, 900)).catch(()=>{})
          window.removeEventListener('touchstart', resume)
          window.removeEventListener('click', resume)
        }
        window.addEventListener('touchstart', resume, {once:true,passive:true})
        window.addEventListener('click', resume, {once:true})
      })
    } else {
      fadeAudio(darkMusic, VOLUME_DARK, 900)
    }
  } catch(e){
    // ensure future resume
    const resume = ()=>{
      darkMusic.play().then(()=> fadeAudio(darkMusic, VOLUME_DARK, 900)).catch(()=>{})
      window.removeEventListener('touchstart', resume)
      window.removeEventListener('click', resume)
    }
    window.addEventListener('touchstart', resume, {once:true,passive:true})
    window.addEventListener('click', resume, {once:true})
  }

  prepareStoryWords()
  intro.classList.add('fade-out')
  setTimeout(()=> intro.classList.add('hidden'), 520)
  storyScene.classList.add('active')

  // reveal words and enable spoiler when done
  const totalMs = revealStoryWords()
  const safety = 420 // small buffer
  setTimeout(()=> enableSpoiler(), totalMs + safety)
}

/* === CRITICAL CHANGE: ensure dark music starts immediately on cat-tap ===
 We replace the simple binding with a handler that:
 1) unlocks audio (priming)
 2) attempts to start darkMusic right away (playWithFadeAndResume)
 3) then shows the story
 This guarantees the play() attempt is done inside the original user gesture.
*/
function onIntroClickGesture(e){
  // 1) Priming: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤ —Ç–æ–º –∂–µ —é–∑–µ—Ä-–∂–µ—Å—Ç–µ
  try {
    // tiny priming volume so it's silent
    darkMusic.volume = 0.01;
    loveMusic.volume = 0.01;

    // optional extra primer file (if you uploaded prime.mp3):
    // const primer = new Audio('prime.mp3');
    // primer.volume = 0.02;
    // primer.play().then(()=>{ primer.pause(); primer.currentTime = 0; }).catch(()=>{});

    // Play+pause both tracks to unlock iOS audio subsystem
    darkMusic.play().then(()=>{ darkMusic.pause(); darkMusic.currentTime = 0; }).catch(()=>{});
    loveMusic.play().then(()=>{ loveMusic.pause(); loveMusic.currentTime = 0; }).catch(()=>{});
  } catch(err) {
    console.warn('Priming failed (best-effort):', err);
  }

  // 2) Try to start dark music immediately (again, inside this gesture)
  try {
    darkMusic.currentTime = 0;
    darkMusic.volume = 0;
    const promise = darkMusic.play();
    if (promise && typeof promise.then === 'function') {
      promise.then(()=>{
        // fade to desired volume
        fadeAudio(darkMusic, VOLUME_DARK, 900);
        console.log('darkMusic.started');
      }).catch((err)=>{
        console.warn('darkMusic.play() blocked, will attach resume listeners:', err);
        // Attach resume listeners for the next user gesture(s)
        const resume = ()=>{
          darkMusic.play().then(()=> fadeAudio(darkMusic, VOLUME_DARK, 900)).catch(()=>{});
          window.removeEventListener('touchstart', resume);
          window.removeEventListener('click', resume);
        };
        window.addEventListener('touchstart', resume, {once:true, passive:true});
        window.addEventListener('click', resume, {once:true});
      });
    } else {
      fadeAudio(darkMusic, VOLUME_DARK, 900);
    }
  } catch(err){
    console.warn('darkMusic play try threw:', err);
    const resume = ()=>{
      darkMusic.play().then(()=> fadeAudio(darkMusic, VOLUME_DARK, 900)).catch(()=>{});
      window.removeEventListener('touchstart', resume);
      window.removeEventListener('click', resume);
    };
    window.addEventListener('touchstart', resume, {once:true, passive:true});
    window.addEventListener('click', resume, {once:true});
  }

  // 3) Continue with the UI: show the story (text reveal, etc.)
  showStory();
}

/* events */
introCard.addEventListener('click', onIntroClickGesture)
introCard.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); onIntroClickGesture(e) }})

/* story close */
storyClose.addEventListener('click', ()=>{
  storyScene.classList.remove('active')
  intro.classList.remove('hidden')
  setTimeout(()=> intro.classList.remove('fade-out'), 10)
})

/* scroll fog parallax */
storyScroll.addEventListener('scroll', ()=>{
  const ratio = storyScroll.scrollTop / Math.max(1, (storyScroll.scrollHeight - storyScroll.clientHeight))
  storyFog.style.transform = `translateY(${ratio * -12}px)`
})

/* spawn helpers (intensified) */
function spawnSplash(cx, cy, intensity = 36){
  for(let i=0;i<intensity;i++){
    const d = document.createElement('div'); d.className='splash'
    const size = 8 + Math.random()*26
    d.style.width = `${size}px`; d.style.height = `${size}px`
    d.style.left = `${cx - size/2}px`; d.style.top = `${cy - size/2}px`
    d.style.background = 'radial-gradient(circle, rgba(255,236,170,.98), rgba(255,170,80,0) 70%)'
    d.style.zIndex = 10092
    const dx = (Math.random()*360)-180; const dy = -(40 + Math.random()*240)
    d.animate([{transform:'translate(0,0) scale(1)',opacity:1},{transform:`translate(${dx}px, ${dy}px) scale(.9)`,opacity:.95},{transform:`translate(${dx*1.05}px, ${dy+240}px) scale(.28)`,opacity:0}], {duration:900 + Math.random()*520, easing:'cubic-bezier(.2,.9,.2,1)', fill:'forwards'})
    document.body.appendChild(d); setTimeout(()=>d.remove(),2000)
  }
}
function spawnFoam(cx, cy, qty = 18){
  for(let i=0;i<qty;i++){
    const f=document.createElement('div'); f.className='foam'
    const size = 5 + Math.random()*14
    f.style.width = `${size}px`; f.style.height = `${size}px`
    f.style.left = `${cx + (Math.random()*80-40)}px`; f.style.top = `${cy + (Math.random()*40-20)}px`
    f.style.background = 'radial-gradient(circle,rgba(255,255,255,.98),rgba(255,255,255,0))'
    f.style.zIndex = 10092
    f.animate([{transform:'translateY(0) scale(1)',opacity:.95},{transform:`translateY(${-12 - Math.random()*40}px) scale(.45)`,opacity:0}], {duration:900 + Math.random()*700, easing:'ease-out', fill:'forwards'})
    document.body.appendChild(f); setTimeout(()=>f.remove(),2000)
  }
}

/* create stain blobs (decorative beer patches) directly under final can */
function createStains(centerX, bottomY){
  stainsCreated.forEach(s => { try{s.remove()}catch(e){} })
  stainsCreated = []
  const specs = [
    {w: 240, h: 60, offX: 0,  offY: 12, opacity:0.85, blur:6},
    {w: 160, h: 44, offX: -36, offY: 26, opacity:0.7, blur:8},
    {w: 120, h: 34, offX: 40, offY: 18, opacity:0.62, blur:10},
    {w: 300, h: 80, offX: 0, offY: 44, opacity:0.45, blur:18}
  ]
  specs.forEach((s,i)=>{
    const st = document.createElement('div'); st.className = 'stain'
    st.style.width = `${s.w}px`; st.style.height = `${s.h}px`
    st.style.left = `${centerX - s.w/2 + s.offX}px`
    st.style.top = `${bottomY + s.offY}px`
    st.style.background = `radial-gradient(ellipse at 30% 40%, rgba(255,235,170,${s.opacity}), rgba(200,120,40,${s.opacity*0.22}))`
    st.style.filter = `blur(${s.blur}px)`
    st.style.opacity = '0'
    st.style.zIndex = 10091
    document.body.appendChild(st)
    st.animate([{transform:'scale(.2)', opacity:0},{transform:'scale(1.02)', opacity:1}], {duration:720 + i*80, easing:'cubic-bezier(.2,.8,.2,1)', fill:'forwards'})
    stainsCreated.push(st)
    st.animate([{opacity:0.85, transform:'translateY(0)'},{opacity:0.7, transform:'translateY(-2px)'},{opacity:0.85, transform:'translateY(0)'}], {duration:4200 + i*300, iterations:Infinity, easing:'ease-in-out'})
  })
  return stainsCreated
}

/* page shake */
function shakePage(){ document.body.classList.add('page-shake'); if(navigator.vibrate) navigator.vibrate([80,30,70]); setTimeout(()=>document.body.classList.remove('page-shake'),600) }

/* puddle cleanup */
function cleanupPuddle(){
  if(puddleTimer) clearTimeout(puddleTimer)
  puddleTimer = setTimeout(()=>{
    puddle.animate([{opacity:1, transform:'translate(-50%,0) scale(1)'},{opacity:0, transform:'translate(-50%,0) scale(.6)'}], {duration:900, easing:'ease-in-out', fill:'forwards'})
    ripple.animate([{opacity:.6, transform:'translate(-50%,0) scale(1)'},{opacity:0, transform:'translate(-50%,0) scale(1.8)'}], {duration:900, easing:'ease-out', fill:'forwards'})
    // stains remain as traces (we will remove them before memes)
  }, 3600)
}

/* beer animation sequence (ensures beer is above all and transitions to memes after full puddle animation) */
function beerAnimationSequence(){
  if(beerStarted) return
  beerStarted = true

  try{
    if(beerLayer.parentNode !== document.body){
      document.body.appendChild(beerLayer)
      beerLayer.style.position = 'fixed'
      beerLayer.style.left = '0'
      beerLayer.style.top = '0'
      beerLayer.style.width = '100%'
      beerLayer.style.height = '100%'
      beerLayer.style.pointerEvents = 'none'
    }
    beerLayer.style.zIndex = '10095'
    beerSprite.style.zIndex = '10096'
  }catch(e){}

  beerSprite.style.display = 'block'
  beerSprite.style.opacity = '1'

  const startX = window.innerWidth * (0.48 + Math.random()*0.06)
  const startY = -window.innerHeight * 0.6
  const endY = window.innerHeight * 0.62
  const startRot = Math.random()*20 - 10
  const endRot = startRot + 300
  const duration = BEER_BASE_DURATION_MS + Math.random()*320
  const t0 = performance.now()

  beerSprite.style.left = `${startX}px`; beerSprite.style.top = `${startY}px`

  function step(now){
    const t = Math.min(1,(now - t0)/duration)
    const eased = t < 1 ? (1 - Math.pow(1 - t, 3)) : 1
    const y = startY + (endY - startY) * eased
    const rot = startRot + (endRot - startRot) * eased
    const flip = 360 * eased
    beerSprite.style.top = `${y}px`
    beerSprite.style.transform = `translateX(-50%) rotateZ(${rot}deg) rotateX(${flip}deg)`
    if(t < 1) requestAnimationFrame(step)
    else {
      // landed
      shakePage()
      fadeAudio(darkMusic, 0, 600)
      beerSfx.volume = SFX_VOLUME; beerSfx.currentTime = 0; beerSfx.play().catch(()=>{})
      spawnSplash(startX, endY + 20, 44)
      spawnFoam(startX, endY + 20, 22)

      const rect = beerSprite.getBoundingClientRect()
      const centerX = rect.left + rect.width/2 + window.scrollX
      const bottomY = rect.bottom + window.scrollY
      const puddleTop = bottomY - Math.max(10, rect.height * 0.06)

      puddle.style.display = 'block'; ripple.style.display = 'block'
      puddle.style.left = `${centerX}px`; puddle.style.top = `${puddleTop}px`
      ripple.style.left = `${centerX}px`; ripple.style.top = `${puddleTop}px`

      // realistic puddle using blobs
      function spawnPuddleBlobs(cx, cy){
        const blobs = 7
        for(let i=0;i<blobs;i++){
          const b = document.createElement('div')
          b.setAttribute('data-beer-blob','1')
          const w = 80 + Math.random()*160
          const h = 30 + Math.random()*70
          b.style.position = 'fixed'
          b.style.left = `${cx}px`
          b.style.top = `${cy}px`
          b.style.width = `${w}px`
          b.style.height = `${h}px`
          b.style.borderRadius = '50%'
          b.style.pointerEvents = 'none'
          b.style.zIndex = 10094
          b.style.background = 'radial-gradient(ellipse at 40% 30%, #fff2c4 0%, #ffdd8a 25%, #c76e21 75%)'
          b.style.filter = 'blur(2px)'
          b.style.transform = 'translate(-50%,-50%) scale(0.1)'
          b.style.opacity = '0'

          document.body.appendChild(b)

          const dx = (Math.random()*160 - 80)
          const dy = (Math.random()*80 - 40)

          b.animate([
            {transform:'translate(-50%,-50%) scale(0.1)', opacity:0},
            {transform:`translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px)) scale(1)`, opacity:1}
          ], {
            duration: 900 + Math.random()*300,
            easing: 'cubic-bezier(.2,.8,.2,1)',
            fill: 'forwards'
          })
        }
      }

      spawnPuddleBlobs(centerX, puddleTop)

      // create nicely positioned animated stains
      createStains(centerX, puddleTop + 8)
      cleanupPuddle()

      // WAIT: play out the puddle animation fully, then transition to romance/memes.
      setTimeout(()=>{
        // remove blobs (they served visual purpose)
        document.querySelectorAll('[data-beer-blob]').forEach(b=>b.remove())

        // remove beer sprite
        beerSprite.style.display = 'none'

        // start romance/memes after puddle completed
        startRomance()
      }, 1400)
    }
  }
  requestAnimationFrame(step)
}

/* reveal spoiler (guarded until ready) */
function revealSpoiler(){
  if(!spoiler.classList.contains('ready')) return
  if(spoiler.classList.contains('open')) return

  // mark open and reveal inline phrase
  spoiler.classList.add('open')
  spoiler.querySelector('.line').removeAttribute('aria-hidden')

  // begin beer drop animation (will itself wait for puddle completion before switching scenes)
  setTimeout(()=> beerAnimationSequence(), 150)
}

/* click handler wiring */
spoiler.addEventListener('click', (e)=>{ e.stopPropagation(); revealSpoiler() })
spoiler.addEventListener('keydown', (e)=>{ if((e.key==='Enter'||e.key===' ') && spoiler.classList.contains('ready')){ e.preventDefault(); revealSpoiler() }})

/* start romance: fade dark, start loveMusic reliably and show memes */
function startRomance(){
  if(romanceStarted) return
  romanceStarted = true

  // hide story scene fully
  storyScene.classList.remove('active')

  // forest visual
  document.getElementById('forestBg').style.opacity = '0.36'
  romanceVideo.style.opacity = '0.6'
  romanceVideo.play().catch(()=>{})

  // Ensure loveMusic is started inside a UX-allowed path if possible.
  // We primed loveMusic at the first user click (unlockAudioImportant),
  // so now we attempt to play it. If blocked, fallback attaches resume listeners.
  try{
    loveMusic.currentTime = 0
    loveMusic.volume = 0
    const p = loveMusic.play()
    if(p && typeof p.then === 'function'){
      p.then(()=> fadeAudio(loveMusic, VOLUME_LOVE, 900)).catch(()=>{
        const resume = ()=>{
          loveMusic.play().then(()=> fadeAudio(loveMusic, VOLUME_LOVE, 900)).catch(()=>{})
          window.removeEventListener('touchstart', resume)
          window.removeEventListener('click', resume)
        }
        window.addEventListener('touchstart', resume, {once:true,passive:true})
        window.addEventListener('click', resume, {once:true})
      })
    } else {
      fadeAudio(loveMusic, VOLUME_LOVE, 900)
    }
  }catch(e){
    const resume = ()=>{
      loveMusic.play().then(()=> fadeAudio(loveMusic, VOLUME_LOVE, 900)).catch(()=>{})
      window.removeEventListener('touchstart', resume)
      window.removeEventListener('click', resume)
    }
    window.addEventListener('touchstart', resume, {once:true,passive:true})
    window.addEventListener('click', resume, {once:true})
  }

  createMemes()
  memesScene.classList.add('active')
}

/* create memes; alternate between meme.png and memes_extra.png; extra image +10% size */
function createMemes(){
  fadeAudio(darkMusic, 0, 800)
  memesScene.innerHTML = ''
  const memes = []
  const bounds = ()=>({w:window.innerWidth,h:window.innerHeight})
  const filenames = []
  for(let i=0;i<MEME_COUNT;i++) filenames.push(i % 2 === 0 ? 'meme.png' : MEME_EXTRA_FILENAME)

  for(let i=0;i<MEME_COUNT;i++){
    const el = document.createElement('div'); el.className = 'meme tap-target'
    el.setAttribute('role','button'); el.setAttribute('tabindex','0')
    const img = document.createElement('img'); img.src = filenames[i]; img.alt = '–º–µ–º-–∫–∞—Ä—Ç–∏–Ω–∫–∞'
    img.onerror = ()=> { if(img.src.endsWith(MEME_EXTRA_FILENAME)) img.src = 'meme.png'; else img.style.display='none' }
    el.appendChild(img); memesScene.appendChild(el)

    const b = bounds()
    let size = 70 + Math.random()*60
    if(filenames[i]===MEME_EXTRA_FILENAME) size = Math.round(size * 1.10) // +10%
    el.style.width = `${size}px`
    const x = Math.random()*(b.w - size)
    const y = Math.random()*(b.h - size)
    memes.push({el,x,y,vx:(Math.random()*0.9+0.2)*(Math.random()>0.5?1:-1),vy:(Math.random()*0.9+0.2)*(Math.random()>0.5?1:-1),size})

    const onClick = ()=> revealConfession()
    el.addEventListener('click', onClick, {once:true})
    el.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); onClick() }}, {once:true})
  }

  function loop(){
    const b = bounds()
    for(let i=0;i<memes.length;i++){
      const a = memes[i]
      a.x += a.vx; a.y += a.vy
      if(a.x < 6 || a.x + a.size > b.w - 6) a.vx *= -1
      if(a.y < 6 || a.y + a.size > b.h - 6) a.vy *= -1
      for(let j=i+1;j<memes.length;j++){
        const c = memes[j]
        const dx = a.x - c.x; const dy = a.y - c.y
        const dist = Math.hypot(dx,dy); const minDist = (a.size + c.size)*0.28
        if(dist < minDist){
          const nx = dx / (dist || 1); const ny = dy / (dist || 1)
          a.vx += nx * 0.08; a.vy += ny * 0.08; c.vx -= nx * 0.08; c.vy -= ny * 0.08
        }
      }
      a.el.style.transform = `translate3d(${a.x}px,${a.y}px,0) rotateZ(${(a.vx+a.vy)*6}deg)`
    }
    memeAnimationId = requestAnimationFrame(loop)
  }
  loop()
}

/* reveal confessions word-by-word */
function revealConfession(){
  if(memeAnimationId) cancelAnimationFrame(memeAnimationId)
  $$('.meme').forEach(m=> m.classList.add('fade-out'))
  setTimeout(()=>{ memesScene.classList.remove('active'); memesScene.innerHTML=''; showConfession() }, 520)
}

/* SHOW CONFESSION (updated text already in HTML) */
/* This function displays confession text letter/word animations and enables the heart after completion */
function showConfession(){
  confessionScene.classList.add('active')

  const rawText = confessionText.textContent.trim()
  const lines = []
  const sentences = rawText.split(/(?<=\.)\s+/)
  if(sentences.length > 1){
    sentences.forEach(s => { if(s.trim()) lines.push(s.trim()) })
  } else {
    lines.push(rawText)
  }

  confessionText.innerHTML = ''
  lines.forEach((line, li)=>{
    const p = document.createElement('p')
    const parts = line.match(/\S+|\s+/g) || [line]
    parts.forEach((part)=>{
      if(/\s+/.test(part)){
        p.appendChild(document.createTextNode(part))
        return
      }
      const wordSpan = document.createElement('span')
      wordSpan.className = 'word'
      const chars = part.split('')
      chars.forEach((ch, ci)=>{
        const charSpan = document.createElement('span')
        charSpan.className = 'char'
        charSpan.style.animationDelay = `${(ci*0.03)}s`
        charSpan.textContent = ch
        wordSpan.appendChild(charSpan)
      })
      p.appendChild(wordSpan)
      p.appendChild(document.createTextNode(' '))
    })
    confessionText.appendChild(p)
    setTimeout(()=>{ p.style.opacity = '1'; p.style.transform = 'translateY(0)' }, 200 + li*420)
  })

  const wordSpans = $$('#confessionText .word')
  wordSpans.forEach((w, i)=> setTimeout(()=>{ w.style.opacity = '1'; w.style.transform = 'translateY(0)' }, i * WORD_DELAY_MS))

  const totalWordMs = wordSpans.length * WORD_DELAY_MS
  const buffer = 420
  setTimeout(()=>{
    heartBtn.classList.add('enabled')
    heartBtn.setAttribute('tabindex','0')
    heartBtn.setAttribute('aria-disabled','false')
    heartCaption.classList.add('visible')
  }, totalWordMs + buffer)
}

/* video overlay: pause/resume loveMusic on open/close */
function openVideo(){
  try{ loveWasPlayingBeforeVideo = !!(loveMusic && !loveMusic.paused && loveMusic.currentTime > 0); }catch(e){ loveWasPlayingBeforeVideo = false }
  try{ if(loveMusic && !loveMusic.paused) loveMusic.pause() }catch(e){}
  const overlay = document.getElementById('videoOverlay')
  overlay.classList.add('active'); overlay.setAttribute('aria-hidden','false')
  document.getElementById('finalVideo').style.display='block'
  document.getElementById('videoPlaceholder').style.display='none'
  try{ document.getElementById('finalVideo').play().catch(()=>{}) }catch(e){}
}
function closeVideo(){
  try{ document.getElementById('finalVideo').pause() }catch(e){}
  const overlay = document.getElementById('videoOverlay')
  overlay.classList.remove('active'); overlay.setAttribute('aria-hidden','true')
  if(loveWasPlayingBeforeVideo){
    try{
      loveMusic.play().then(()=> fadeAudio(loveMusic, VOLUME_LOVE, 700)).catch(()=>{})
    }catch(e){}
    loveWasPlayingBeforeVideo = false
  }
}

heartBtn.addEventListener('click', (e)=>{ if(heartBtn.classList.contains('enabled')) openVideo() })
heartBtn.addEventListener('keydown', (e)=>{ if((e.key==='Enter'||e.key===' ') && heartBtn.classList.contains('enabled')){ e.preventDefault(); openVideo() }})
document.getElementById('videoOverlay').addEventListener('click', (e)=>{ if(e.target === document.getElementById('videoOverlay')){ closeVideo() } })

/* initial volumes */
darkMusic.volume = 0
loveMusic.volume = 0
beerSfx.volume = SFX_VOLUME

/* Accessibility: ensure spoiler initially disabled until story words done */
spoiler.setAttribute('aria-disabled','true')
spoiler.tabIndex = -1

/* ensure heart initially not keyboard-focusable */
heartBtn.setAttribute('aria-disabled','true')
heartBtn.tabIndex = -1

</script>
</body>
</html>

